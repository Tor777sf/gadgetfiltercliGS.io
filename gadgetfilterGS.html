<!--segundo nivel 2.5-->
<--Cliente-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheet CSV</title>

  <!--  LIBRERIAS -->
  <!-- Bulma CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!-- Popper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">

<!-- WhatsApp Click to Chat JS -->
<script src="https://cdn.jsdelivr.net/npm/whatsapp-click-to-chat/dist/index.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>

<!-- PapaParse JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

<!-- PDFLib JS -->
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

<!-- jsPDF JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <!-- FIN  LIBRERIAS -->
  
  <!--  DISEﾃ前 Y ESTRUCTURA WEB--> 
  <style>
    /* Coloca aquﾃｭ el bloque de estilos CSS */
    .shopping-item {
      font-size: 16px;
      list-style-type: none;
      padding: 8px 0;
      border-bottom: 1px solid #ccc;
    }

    .item-quantity {
      display: inline-block;
      width: 10%;
    }

    .item-description {
      display: inline-block;
      width: 50%;
    }

    .item-total {
      display: inline-block;
      width: 30%;
      text-align: right;
    }
  </style>
  <!-- FIN DISEﾃ前 Y ESTRUCTURA WEB-->
  
</head>
<body>
  
  <!--  DISEﾃ前 Y ESTRUCTURA WEB-->
  
<!-- Nueva secciﾃｳn para la lista de compra -->
<div id="shoppingList">
  <h2>Lista de Compra</h2>
  <ul id="shoppingItems">
    <!-- Los ﾃｭtems de la lista de compra se agregarﾃ｡n aquﾃｭ dinﾃ｡micamente -->
  </ul>
  <p>Total de Compra: <span id="totalPurchase">$0.00</span></p>
  <button id="whatsappButton">Compartir por WhatsApp</button>
  <button id="downloadPDFButton">Descargar PDF</button>

</div>
  
<table id="myDataTable" class="display">
  <!-- DataTable content will be dynamically generated here -->
</table>

  <!--  FIN DISEﾃ前 Y ESTRUCTURA WEB-->

<script>
  
   // <!--  DISEﾃ前 Y ESTRUCTURA WEB-->
      
  $(document).ready(function () {
   // Descargar y parsear el archivo CSV
    Papa.parse('https://docs.google.com/spreadsheets/d/1X0WN5st8Bl6G6_QPtC9gS6vY4PyFR5dAjXxWU7UiOYE/export?format=csv&gid=0', {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function (results) {
        // Crear DataTable
        var dataTable = $('#myDataTable').DataTable({
          data: results.data,
          columns: Object.keys(results.data[0]).map(function(key) {
            return { data: key, title: key };
          }),
          columnDefs: [
            {
              targets: 10,
              render: function (data, type, row) {
                // Personalizar renderizado para la columna con enlaces no vacﾃｭos
                return data && data !== "" ? '<a href="' + data + '" target="_blank"><img src="' + data + '" alt="Ver Foto" style="height: 100px; width: auto;" /></a>' : "";
              }
            }
          ]
        });

 

        // Nueva lista de compra
        var shoppingList = [];
        var totalPurchase = 0;
        
 // <!-- FIN DISEﾃ前 Y ESTRUCTURA WEB-->
        
// ...

        //-----INTERACTUA CON EL USUARIO-----
// Agregar evento clic para generar lista de compra
///$('#myDataTable tbody').on('click', 'tr', function () {
        
// Capturar el evento clic del campo de precio para habilitar la ediciﾃｳn y permitir solo nﾃｺmeros
//$('#priceInput').click(function() {
    //$(this).removeAttr('readonly');
//}); 

// Validar que solo se ingresen nﾃｺmeros durante la ediciﾃｳn del precio
$('#priceInput').on('input', function() {
    var sanitized = $(this).val().replace(/[^0-9.]/g, '');
    $(this).val(sanitized);
});

// Capturar el valor del precio antes de la ediciﾃｳn
//var previousPrice;

//$('#priceInput').focus(function() {
   // previousPrice = $(this).val();
//});


    // Al perder el enfoque del campo de precio, verificar y ajustar la cantidad si es necesario
$('#priceInput').change(function() {
    var newPrice = $(this).val();

    // Verificar si el nuevo precio es menor que el precio anterior
    if (parseFloat(newPrice) < parseFloat(previousPrice)) {
        var quantity = $('#quantityInput').val(); // Obtener la cantidad ingresada
        if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
            // Calcular la nueva cantidad
            var newQuantity = (parseFloat(quantity) / parseFloat(previousPrice)) * parseFloat(newPrice);
     
            $('#quantityInput').val(newQuantity); //.toFixed(6) Actualizar el campo de cantidad
        }
    }
    // Si el nuevo precio es mayor o igual que el precio anterior
    else {
        var newQuantity = parseFloat(newPrice) / parseFloat(previousPrice);
        $('#quantityInput').val(newQuantity); //.toFixed(6) Actualizar el campo de cantidad
    }

    // Bloquear la escritura en el campo de cantidad
   // $('#quantityInput').attr('readonly', true);

    // Volver a establecer el campo de precio como de solo lectura
    //$(this).attr('readonly', true);
});

  
// Variable para almacenar la configuraciﾃｳn inicial del modal
var initialModalSettings = {
    description: "",
    quantity: "1",
    price: "0.00",
   // readonly: false
};

// Capturar el evento clic al seleccionar un ﾃｭtem en la tabla
$('#myDataTable tbody').on('click', 'tr', function () {
    try {
        var data = dataTable.row(this).data(); // Obtener datos de la fila clicada

        // Verificar si la descripciﾃｳn del producto estﾃ｡ definida
        if (data && data.DESCRIPCION) {
            // Mostrar el formulario modal
            $('#quantityModal').modal('show');

            // Actualizar campos del modal con datos de la fila
            try {
                if (data.DESCRIPCION.toLowerCase() === '.p') {
                  // Si la descripciﾃｳn es igual a '.p'
                     $('#descriptionInput').focus();
                    //  $('#descriptionInput').select();

                    initialModalSettings = {
                        description: "",
                        quantity: "1",
                        price: "0.00",
                        //readonly: false
                    };
                      
                      
                } else {
                    // Si no contiene '.p', establecer la descripciﾃｳn y otros campos normalmente
                    initialModalSettings = {
                        description: data.DESCRIPCION,
                        quantity: "1",
                        //price: data.Total() || 'Precio no disponoble';
                        price: parseFloat(data.Total.replace(',', '.')) || 'Precio no disponible'
                        //var price = parseFloat(data.Total.replace(',', '.'));
 
                      //readonly: false
                    };
                }
                
                // Restaurar la configuraciﾃｳn inicial del modal
                $('#descriptionInput').val(initialModalSettings.description);
                $('#quantityInput').val(initialModalSettings.quantity);
                $('#priceInput').val(initialModalSettings.price).attr('readonly', initialModalSettings.readonly);

                var imageLink = data.ENLACES; // Obtener el enlace de la imagen directamente de la columna "ENLACES"
                if (imageLink) {
                    // Mostrar la imagen en el modal
                    $('#imageContainer').html('<img src="' + imageLink + '" alt="Imagen del producto">');
                } else {
                    $('#imageContainer').html('Imagen no disponible');
                }
            } catch (error) {
                alert('Error al actualizar los campos del modal: ' + error.message);
            }
        } else {
            alert('Descripciﾃｳn del producto no definida. Intente de nuevo.');
        }
    } catch (error) {
        alert('Error al procesar el clic en la tabla: ' + error.message);
    }
});

// Definir la variable previousPrice fuera del alcance de los eventos
var previousPrice;

// Capturar el evento mostrado del modal
$('#quantityModal').on('shown.bs.modal', function () {
    $('#quantityInput').attr('readonly', false);
    $('#priceInput').attr('readonly', false);

    // Llenar previousPrice solo cuando se muestra el modal
    previousPrice = $('#priceInput').val();
});



// Capturar el evento clic del botﾃｳn "Agregar" en el formulario modal
$('#addQuantityBtn').off('click').on('click', function () {
    try {
        var quantity = $('#quantityInput').val(); // Obtener la cantidad ingresada
        var price = previousPrice; // Obtener el precio
        if (!quantity || isNaN(quantity) || quantity <= 0) {
             quantity = 0;
         }

        if (!price || isNaN(price) || price < 0) {
          price = 0.00;
        }

        // La cantidad y el precio son vﾃ｡lidos, procede con el proceso de agregar a la lista de compra
        var totalItem = parseFloat(price) * parseFloat(quantity);

        totalPurchase += totalItem;

        shoppingList.push({
            producto: $('#descriptionInput').val(),
            cantidad: quantity.toFixed(6),
            precio: parseFloat(price), // Usar el precio original, no el precio modificado
            total: totalItem.toFixed(2),
        });

        updateShoppingList();

        $('#quantityModal').modal('hide'); // Ocultar el formulario modal
    } catch (error) {
        alert('Error al agregar la cantidad: ' + error.message);
    }
});

//:: fin Agregar evento clic para generar lista de compra
        
// .

// ...
//   inicio botones Whatsapp y pdf

// Funciﾃｳn para formatear la lista de compra para WhatsApp
function formatShoppingListForWhatsApp() {
  let formattedList = '*沒 Lista de Compra:*\n\n';
  for (let i = 0; i < shoppingList.length; i++) {
    const item = shoppingList[i];
    formattedList += `泝 *${item.cantidad}x ${item.producto}* - _Total: _$${item.total}_\n`;
    formattedList += '笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏\n'; // Lﾃｭnea decorativa
  }
  formattedList += `\n汳ｰ *Total de Compra:* _$${totalPurchase.toFixed(2)}_`;

  // Agregar enlace al GIF
  const gifURL = 'https://media2.giphy.com/media/3o72Fj8mcEJC5InEFa/200w.webp?cid=ecf05e47iogotsnrkib2qj85yqifajv7o5c4j9e7bws0e8f2&ep=v1_gifs_related&rid=200w.webp&ct=g'; // URL directa al GIF
  formattedList += `\n\nﾂ｡Mira este GIF increﾃｭble!\n${gifURL}\n\n`;

  return formattedList;
}

// Funciﾃｳn para formatear la lista de compra para el PDF
function formatShoppingListForPDF() {
  let formattedList = 'Lista de Compra:\n\n';
  for (let i = 0; i < shoppingList.length; i++) {
    const item = shoppingList[i];
    formattedList += `${item.cantidad}x ${item.producto} - Total: $${item.total}\n`;
    //formattedList += '笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏\n'; // Lﾃｭnea decorativa
  }
  formattedList += `\nTotal de Compra: $${totalPurchase.toFixed(2)}`;

  return formattedList;
}

// Descargar PDF al hacer clic en el botﾃｳn "Descargar PDF"
$('#downloadPDFButton').on('click', async function () {
  try {
    // Crear el objeto PDF en blanco
    const pdfDoc = await PDFLib.PDFDocument.create();

    // Agregar una nueva pﾃ｡gina al PDF
    const page = pdfDoc.addPage();

    // Establecer el tamaﾃｱo y la posiciﾃｳn del texto
    const textSize = 12;
    const textX = 20;
    const textY = 750;

    // Obtener la lista de compra formateada para PDF
    const formattedListForPDF = formatShoppingListForPDF();

    // Agregar texto a la pﾃ｡gina utilizando la fuente predeterminada
    page.drawText(formattedListForPDF, { x: textX, y: textY, size: textSize });

    // Guardar el PDF como un blob
    const pdfBytes = await pdfDoc.save();

    // Crear el enlace de descarga para el PDF
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(new Blob([pdfBytes], { type: 'application/pdf' }));
    downloadLink.download = 'Lista_de_Compra.pdf';

    // Simular un clic en el enlace para abrir la ventana de descarga
    downloadLink.click();
  } catch (error) {
    alert('Error al crear/descargar el PDF: ' + error.message);
  }
});

// Funciﾃｳn para compartir en WhatsApp al hacer clic en el botﾃｳn
$('#whatsappButton').on('click', function () {
  try {
    // Obtener la lista de compra formateada para WhatsApp
    const formattedListForWhatsApp = formatShoppingListForWhatsApp();

    // Abrir WhatsApp con el mensaje
    const whatsappLink = 'whatsapp://send?text=' + encodeURIComponent(formattedListForWhatsApp);

    // Redirigir a la aplicaciﾃｳn de WhatsApp o abrir en una nueva ventana
    window.open(whatsappLink, '_blank');
  } catch (error) {
    alert('Error al compartir en WhatsApp: ' + error.message);
  }
});
// fin botones Whatsapp y pdf


          // Agregar evento cuando el modal se muestre

  
            $('#quantityModal').on('shown.bs.modal', function () {
            // Establecer el valor predeterminado en 1
            $('#quantityInput').val('1');
            
            // Seleccionar todo el texto en el campo de cantidad
            $('#quantityInput').select();
        });
        // fin agregar evento modal
        
        
        // Funciﾃｳn para actualizar la lista de compra en la interfaz
        function updateShoppingList() {
          var shoppingItems = $('#shoppingItems');
          var totalPurchaseElement = $('#totalPurchase');

          // Limpiar lista de compra
          shoppingItems.empty();

          // Construir y agregar nuevos elementos a la lista de compra
          for (var i = 0; i < shoppingList.length; i++) {
            var item = shoppingList[i];
            var listItem = '<li class="shopping-item">' +
               '<span class="item-quantity">' + item.cantidad + 'x</span>' +
               '<span class="item-description">' + item.producto + '</span>' +
               '<span class="item-total">Total: $' + item.total + '</span>' +
               '</li>';

            shoppingItems.append(listItem);
          }//fin for

          // Actualizar el total de la compra global
          totalPurchaseElement.text('$' + totalPurchase.toFixed(2));
        }
        //fin actualizar la lista compras
      }
    });
  });
    //--  FIN DE INTERACTUAR CON EL USUARIO--
</script>
      
  <!--  DISEﾃ前 Y ESTRUCTURA WEB-->   
<!-- Modal -->
<div class="modal fade" id="quantityModal" tabindex="-1" role="dialog" aria-labelledby="quantityModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quantityModalLabel">Detalles del Producto</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="quantityForm">
          <div class="form-group">
            <label for="descriptionInput">Descripciﾃｳn:</label>
            <input type="text" class="form-control" id="descriptionInput" >
          </div>
          <div class="form-group">
            <label for="quantityInput">Cantidad:</label>
            <input type="number" class="form-control" id="quantityInput" value="1" required>
          </div>
          <div class="form-group">
            <label for="priceInput">Precio:</label>
            <input type="text" class="form-control" id="priceInput">
          </div>
          <div class="form-group">
            <label for="imageInput">Imagen:</label>
            <div id="imageContainer"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data
        
         fin -->
  
  <!-- FIN DISEﾃ前 Y ESTRUCTURA WEB-->
  
</body>
</html>
