<!--segundo nivel 2.8-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheet CSV</title>
<!-- Bulma CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!-- Popper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">

<!-- WhatsApp Click to Chat JS -->
<script src="https://cdn.jsdelivr.net/npm/whatsapp-click-to-chat/dist/index.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>

<!-- PapaParse JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

<!-- PDFLib JS -->
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

<!-- jsPDF JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

  <style>
    /* Coloca aquí el bloque de estilos CSS */
    .shopping-item {
      font-size: 16px;
      list-style-type: none;
      padding: 8px 0;
      border-bottom: 1px solid #ccc;
    }

    .item-quantity {
      display: inline-block;
      width: 10%;
    }

    .item-description {
      display: inline-block;
      width: 50%;
    }

    .item-total {
      display: inline-block;
      width: 30%;
      text-align: right;
    }
  </style>

</head>
<body>

<!-- Nueva sección para la lista de compra -->
<div id="shoppingList">
  <h2>Lista de Compra</h2>
  <ul id="shoppingItems">
    <!-- Los ítems de la lista de compra se agregarán aquí dinámicamente -->
  </ul>
  <p>Total de Compra: <span id="totalPurchase">$0.00</span></p>
  <button id="whatsappButton">Compartir por WhatsApp</button>
  <button id="downloadPDFButton">Descargar PDF</button>

</div>
  
<table id="myDataTable" class="display">
  <!-- DataTable content will be dynamically generated here -->
</table>



<script>
  // Capturar errores de JavaScript y mostrarlos en una alerta
window.onerror = function(message, source, lineno, colno, error) {
    alert("Error: " + message + "\n" + "File: " + source + "\n" + "Line: " + lineno);
    return true; // Evitar que el navegador muestre su propio mensaje de error en la consola
};
  
  $(document).ready(function () {
   // Descargar y parsear el archivo CSV
    Papa.parse('https://docs.google.com/spreadsheets/d/1X0WN5st8Bl6G6_QPtC9gS6vY4PyFR5dAjXxWU7UiOYE/export?format=csv&gid=0', {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function (results) {
        // Crear DataTable
        var dataTable = $('#myDataTable').DataTable({
          data: results.data,
          columns: Object.keys(results.data[0]).map(function(key) {
            return { data: key, title: key };
          }),
          columnDefs: [
            {
              targets: 10,
              render: function (data, type, row) {
                // Personalizar renderizado para la columna con enlaces no vacíos
                return data && data !== "" ? '<a href="' + data + '" target="_blank"><img src="' + data + '" alt="Ver Foto" style="height: 100px; width: auto;" /></a>' : "";
              }
            }
          ]
        });

 

        // Nueva lista de compra
        var shoppingList = [];
        var totalPurchase = 0;

// ...

        
$('#priceInput').click(function() {
    // Seleccionar todo el texto dentro del campo de entrada
    $(this).select();
    // Eliminar la propiedad 'readonly'
    $(this).removeAttr('readonly');
});

// Validar que solo se ingresen números durante la edición del precio
$('#priceInput').on('input', function() {
    var sanitized = $(this).val().replace(/[^0-9.]/g, '');
    $(this).val(sanitized);
});

// Capturar el valor del precio antes de la edición
var previousPrice;
var nuevoProducto;
        
//$('#priceInput').focus(function() {
  //  previousPrice = $(this).val();
//});

// Al perder el enfoque del campo de precio, verificar y ajustar la cantidad si es necesario
$('#priceInput').change(function() {
    // Verificar el valor de nuevoProducto
    if (nuevoProducto === "si") {
        // No hacer nada si nuevoProducto es "si"
        return;
    } else if (nuevoProducto === "no") {
        var newPrice = parseFloat($(this).val());

        // Verificar si el nuevo precio es menor o igual que el precio anterior
        if (newPrice <= parseFloat(previousPrice)) {
            var quantity = parseFloat($('#quantityInput').val()); // Obtener la cantidad ingresada
            if (!isNaN(quantity) && quantity > 0) {
                // Calcular la nueva cantidad
                var newQuantity = (quantity / parseFloat(previousPrice)) * newPrice;

                $('#quantityInput').val(newQuantity.toFixed(2)); // Actualizar el campo de cantidad
            }
        } else {
            // Si el nuevo precio es mayor o igual que el precio anterior
            // Establecer la cantidad como el nuevo precio dividido por el precio anterior
            $('#quantityInput').val((newPrice / parseFloat(previousPrice)).toFixed(2));
        }
    }

    // Volver a establecer el campo de precio como de solo lectura
    //$(this).attr('readonly', true);
});

// Al cambiar el valor de cantidad
$('#quantityInput').change(function() {
    // Verificar si el producto es "no" y si la cantidad ha sido editada
    if (nuevoProducto === "no") {
        // Establecer el valor del campo de precio como previousPrice
        $('#priceInput').val(previousPrice);
    }
});

    
// Convertir precio a número con punto decimal
function convertirPrecio(precio) {
    // Verificar si el precio es un número
    if (!isNaN(precio)) {
        // Si el precio es un número válido, simplemente devolverlo
        return parseFloat(precio);
    } else if (precio.trim() !== '') {
        // Si el precio no es un número y no está vacío, intentar limpiar y convertirlo
        // Eliminar cualquier carácter que no sea dígito o punto
        precio = precio.replace(/[^\d,.]/g, '');

           //precio = precio.replace(/[^\d,.]/g, '');
      //Reemplasa coma por punto  
       precio = precio.replace(',', '.');
        // Convertir el string limpio a número
        return parseFloat(precio);
    } else {
        // Si el precio está vacío, nulo o es 0, devolver 0
        return 0;
    }
}

// Capturar el evento clic al seleccionar un ítem en la tabla
$('#myDataTable tbody').on('click', 'tr', function () {
    try {
        var data = dataTable.row(this).data(); // Obtener datos de la fila clicada

        // Verificar si la descripción del producto está definida
        if (data && data.DESCRIPCION) {
            // Mostrar el formulario modal
            $('#quantityModal').modal('show');

            // Verificar si la descripción del producto es "xp" (sin diferenciar mayúsculas y minúsculas)
            var descripcion = data.DESCRIPCION.toLowerCase(); // Convertir la descripción a minúsculas
            var precio = convertirPrecio(data.Total); // Convertir el precio a número con punto decimal
            var imageLink = ""; // Enlace de la imagen por defecto

            if (descripcion === "xp") {
                // Si la descripción es "xp", establecer la descripción, el precio y la imagen como vacíos
                $('#descriptionInput').val("");
                $('#priceInput').val("0.00");
                $('#imageContainer').html(""); // Limpiar el contenedor de imagen
                previousPrice = 0;
                nuevoProducto="si";

            } else {
                // Si la descripción no es "xp", establecer la descripción y el precio según los datos de la fila
                $('#descriptionInput').val(data.DESCRIPCION);
                // Verificar si el precio es 0, mostrar "0.00", de lo contrario, mostrar el precio formateado con dos decimales
                $('#priceInput').val(precio === 0 ? '0.00' : precio.toFixed(2));
                imageLink = data.ENLACES; // Obtener el enlace de la imagen directamente de la columna "ENLACES"
                previousPrice = $('#priceInput').val();
                nuevoProducto="no";
            }

            if (imageLink) {
                // Mostrar la imagen en el modal
                $('#imageContainer').html('<img src="' + imageLink + '" alt="Imagen del producto">');
            } else {
                $('#imageContainer').html('Imagen no disponible');
            }

            // Capturar el evento clic del botón "Agregar" en el formulario modal
            $('#addQuantityBtn').off('click').on('click', function () {
                try {
                    var quantity = $('#quantityInput').val(); // Obtener la cantidad ingresada
                    var price = $('#priceInput').val(); // Obtener el precio
                    if (!quantity || isNaN(quantity) || quantity <= 0 || !price || isNaN(price) || price <= 0) {
                        alert('La cantidad y el precio deben ser números positivos.');
                        return;
                    }

                    // La cantidad y el precio son válidos, procede con el proceso de agregar a la lista de compra
                    var totalItem = parseFloat(price) * parseFloat(quantity);
                    totalPurchase += totalItem;

                    shoppingList.push({
                    producto: $('#descriptionInput').val(), // Obtener el valor del campo de descripción
                    cantidad: quantity,
                    precio: previousPrice, // Agregar el precio modificado a la lista de compras
                    total: totalItem.toFixed(2),
                    });


                    updateShoppingList();

                    $('#quantityModal').modal('hide'); // Ocultar el formulario modal
                } catch (error) {
                    alert('Error al agregar la cantidad: ' + error.message);
                }
            });
        } else {
            alert('Descripción del producto no definida. Intente de nuevo.');
        }
    } catch (error) {
        alert('Error al procesar el clic en la tabla: ' + error.message);
    }
});


//:: fin Agregar evento clic para generar lista de compra
        
// .

// ...
//   inicio botones Whatsapp y pdf

// Función para formatear la lista de compra para WhatsApp
function formatShoppingListForWhatsApp() {
  let formattedList = '*📋 Lista de Compra:*\n\n';
  for (let i = 0; i < shoppingList.length; i++) {
    const item = shoppingList[i];
    formattedList += `🛒 *${item.cantidad}x ${item.producto}* - _Total: _$${item.total}_\n`;
    formattedList += '─────────────────────────────\n'; // Línea decorativa
  }
  formattedList += `\n💰 *Total de Compra:* _$${totalPurchase.toFixed(2)}_`;

  // Agregar enlace al GIF
  const gifURL = 'https://media2.giphy.com/media/3o72Fj8mcEJC5InEFa/200w.webp?cid=ecf05e47iogotsnrkib2qj85yqifajv7o5c4j9e7bws0e8f2&ep=v1_gifs_related&rid=200w.webp&ct=g'; // URL directa al GIF
  formattedList += `\n\n¡Mira este GIF increíble!\n${gifURL}\n\n`;

  return formattedList;
}

// Función para formatear la lista de compra para el PDF
function formatShoppingListForPDF() {
  let formattedList = 'Lista de Compra:\n\n';
  for (let i = 0; i < shoppingList.length; i++) {
    const item = shoppingList[i];
    formattedList += `${item.cantidad}x ${item.producto} - Total: $${item.total}\n`;
    //formattedList += '─────────────────────────────\n'; // Línea decorativa
  }
  formattedList += `\nTotal de Compra: $${totalPurchase.toFixed(2)}`;

  return formattedList;
}

// Descargar PDF al hacer clic en el botón "Descargar PDF"
$('#downloadPDFButton').on('click', async function () {
  try {
    // Crear el objeto PDF en blanco
    const pdfDoc = await PDFLib.PDFDocument.create();

    // Agregar una nueva página al PDF
    const page = pdfDoc.addPage();

    // Establecer el tamaño y la posición del texto
    const textSize = 12;
    const textX = 20;
    const textY = 750;

    // Obtener la lista de compra formateada para PDF
    const formattedListForPDF = formatShoppingListForPDF();

    // Agregar texto a la página utilizando la fuente predeterminada
    page.drawText(formattedListForPDF, { x: textX, y: textY, size: textSize });

    // Guardar el PDF como un blob
    const pdfBytes = await pdfDoc.save();

    // Crear el enlace de descarga para el PDF
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(new Blob([pdfBytes], { type: 'application/pdf' }));
    downloadLink.download = 'Lista_de_Compra.pdf';

    // Simular un clic en el enlace para abrir la ventana de descarga
    downloadLink.click();
  } catch (error) {
    alert('Error al crear/descargar el PDF: ' + error.message);
  }
});

// Función para compartir en WhatsApp al hacer clic en el botón
$('#whatsappButton').on('click', function () {
  try {
    // Obtener la lista de compra formateada para WhatsApp
    const formattedListForWhatsApp = formatShoppingListForWhatsApp();

    // Abrir WhatsApp con el mensaje
    const whatsappLink = 'whatsapp://send?text=' + encodeURIComponent(formattedListForWhatsApp);

    // Redirigir a la aplicación de WhatsApp o abrir en una nueva ventana
    window.open(whatsappLink, '_blank');
  } catch (error) {
    alert('Error al compartir en WhatsApp: ' + error.message);
  }
});
// fin botones Whatsapp y pdf


          // Agregar evento cuando el modal se muestre
            $('#quantityModal').on('shown.bs.modal', function () {
            // Establecer el valor predeterminado en 1
            $('#quantityInput').val('1');
            
            // Seleccionar todo el texto en el campo de cantidad
            $('#quantityInput').select();
        });
        // fin agregar evento modal
        
        
        // Función para actualizar la lista de compra en la interfaz
        function updateShoppingList() {
          var shoppingItems = $('#shoppingItems');
          var totalPurchaseElement = $('#totalPurchase');

          // Limpiar lista de compra
          shoppingItems.empty();

          // Construir y agregar nuevos elementos a la lista de compra
          for (var i = 0; i < shoppingList.length; i++) {
            var item = shoppingList[i];
            var listItem = '<li class="shopping-item">' +
               '<span class="item-quantity">' + item.cantidad + 'x</span>' +
               '<span class="item-description">' + item.producto + '</span>' +
               '<span class="item-price">Precio: $' + item.precio + '</span>' +
               '<span class="item-total">Total: $' + item.total + '</span>' +
               '</li>';


            shoppingItems.append(listItem);
          }//fin for

          // Actualizar el total de la compra global
          totalPurchaseElement.text('$' + totalPurchase.toFixed(2));
        }


        
        //fin actualizar la lista compras
//:::;;;;;;;;;;;;codigo modal edicion::::::::::':::    
       

        
    // Agregar controlador de eventos blur al campo de cantidad
    $('#editQuantity').on('blur', function() {
        // Obtener los valores actuales de cantidad y precio
        var cantidad = parseFloat($(this).val());
        var precio = parseFloat($('#editPrice').val());

        // Verificar si ambos valores son numéricos
        if (!isNaN(cantidad) && !isNaN(precio)) {
            // Calcular el total y actualizar el campo correspondiente
            $('#editTotal').val((cantidad * precio).toFixed(2));
        }
    });

    // Agregar controlador de eventos blur al campo de precio
    $('#editPrice').on('blur', function() {
        // Obtener los valores actuales de cantidad y precio
        var cantidad = parseFloat($('#editQuantity').val());
        var precio = parseFloat($(this).val());

        // Verificar si ambos valores son numéricos
        if (!isNaN(cantidad) && !isNaN(precio)) {
            // Calcular el total y actualizar el campo correspondiente
            $('#editTotal').val((cantidad * precio).toFixed(2));
        }
    });
                          

    
    
    // Agregar controlador de eventos input al campo de cantidad
    $('#editQuantity').on('input', function() {
        // Obtener el valor actual del campo de cantidad
        var value = $(this).val();

        // Filtrar caracteres no numéricos y más de un punto decimal
        value = value.replace(/[^\d.]/g, ''); // Mantener solo dígitos y puntos decimales
        value = value.replace(/^(\d*\.\d*)\..*$/, '$1'); // Mantener solo un punto decimal

        // Actualizar el valor del campo de cantidad con la entrada filtrada
        $(this).val(value);
    });

    // Agregar controlador de eventos input al campo de precio
    $('#editPrice').on('input', function() {
        // Obtener el valor actual del campo de precio
        var value = $(this).val();

        // Filtrar caracteres no numéricos y más de un punto decimal
        value = value.replace(/[^\d.]/g, ''); // Mantener solo dígitos y puntos decimales
        value = value.replace(/^(\d*\.\d*)\..*$/, '$1'); // Mantener solo un punto decimal

        // Actualizar el valor del campo de precio con la entrada filtrada
        $(this).val(value);
    });

    // Agregar controlador de eventos input al campo de total
    $('#editTotal').on('input', function() {
        // Obtener el valor actual del campo de total
        var value = $(this).val();

        // Filtrar caracteres no numéricos y más de un punto decimal
        value = value.replace(/[^\d.]/g, ''); // Mantener solo dígitos y puntos decimales
        value = value.replace(/^(\d*\.\d*)\..*$/, '$1'); // Mantener solo un punto decimal

        // Actualizar el valor del campo de total con la entrada filtrada
        $(this).val(value);
    });
      

 

                                 

    // Agregar controlador de eventos clic al contenedor de la lista de compras
    $('#shoppingItems').on('click', '.shopping-item', function() {
        // Remover la clase 'active' de todos los elementos de la lista de compras
        $('.shopping-item').removeClass('active');
        
        // Agregar la clase 'active' al elemento clicado para resaltarlo visualmente
        $(this).addClass('active');

        // Obtener los datos del elemento clicado
        var cantidad = $(this).find('.item-quantity').text().trim().replace('x', ''); // Eliminar 'x' y espacios
        var descripcion = $(this).find('.item-description').text().trim();
        var precio = $(this).find('.item-price').text().trim().replace('Precio: $', ''); // Eliminar 'Precio: $'
        var total = $(this).find('.item-total').text().trim().replace('Total: $', ''); // Eliminar 'Total: $'

        // Llenar el modal con los datos del elemento clicado
        $('#editItemModal').modal('show'); // Mostrar el modal
        $('#editDescription').val(descripcion);
        $('#editQuantity').val(cantidad);
        $('#editPrice').val(precio);
        $('#editTotal').val(total);
    });
//------&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&_
    // Agregar controlador de eventos clic al botón "Guardar Cambios" del modal
  ///  $('#saveChangesBtn').on('click', function() {
        // Actualizar los datos del elemento de la lista de compras con los valores editados
  ///      var shoppingItem = $('.shopping-item.active');
   ///     shoppingItem.find('.item-quantity').text($('#editQuantity').val() + 'x');
    ///    shoppingItem.find('.item-description').text($('#editDescription').val());
    ///    shoppingItem.find('.item-price').text('Precio: $' + $('#editPrice').val());
    ///    shoppingItem.find('.item-total').text('Total: $' + $('#editTotal').val());

        // Ocultar el modal después de guardar los cambios
   ///     $('#editItemModal').modal('hide');
   /// });
//-------&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
// Agregar controlador de eventos clic al botón "Guardar Cambios" del modal
$('#saveChangesBtn').on('click', function() {
    // Obtener el índice del elemento activo en la lista de compras
    var index = $('.shopping-item').index($('.shopping-item.active'));
    
    // Verificar si se ha seleccionado un elemento
    if (index >= 0) {
        // Actualizar los datos del elemento correspondiente en shoppingList
        shoppingList[index].cantidad = $('#editQuantity').val();
        shoppingList[index].producto = $('#editDescription').val();
        shoppingList[index].precio = $('#editPrice').val();
        shoppingList[index].total = $('#editTotal').val();

        // Actualizar la lista de compras en la interfaz
        updateShoppingList();

        // Ocultar el modal después de guardar los cambios
        $('#editItemModal').modal('hide');
    } else {
        // Mostrar mensaje de error si no se seleccionó ningún elemento
        alert('Por favor, selecciona un elemento de la lista de compras.');
    }
});


//-------&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&

        
        // Agregar controlador de eventos clic al botón "Borrar" del modal
    $('#deleteItemBtn').on('click', function() {
    // Obtener el elemento activo de la lista de compras
    var shoppingItem = $('.shopping-item.active');
    
    // Verificar si se ha seleccionado un elemento
    if (shoppingItem.length > 0) {
        // Obtener el índice del elemento en shoppingList
        var index = $('.shopping-item').index(shoppingItem);

        // Eliminar el elemento de shoppingList
        shoppingList.splice(index, 1);

        // Actualizar la lista de compras en la interfaz
        updateShoppingList();

        // Ocultar el modal después de borrar el elemento
        $('#editItemModal').modal('hide');
    } else {
        // Mostrar mensaje de error si no se seleccionó ningún elemento
        alert('Por favor, selecciona un elemento de la lista de compras.');
    }
});


    


  

//::::::::::::;;;;fin codigo modal edicion:::::::::::
      }
    });
  });
</script>
<!-- Modal -->
<div class="modal fade" id="quantityModal" tabindex="-1" role="dialog" aria-labelledby="quantityModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quantityModalLabel">Detalles del Producto</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="quantityForm">
          <div class="form-group">
            <label for="descriptionInput">Descripción:</label>
            <textarea class="form-control" id="descriptionInput" rows="3"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="quantityInput">Cantidad:</label>
              <input type="number" class="form-control" id="quantityInput" value="1">
            </div>
            <div class="form-group col-md-6">
              <label for="priceInput">Precio:</label>
              <input type="text" class="form-control" id="priceInput">
            </div>
          </div>
          <div class="form-group">
            <label for="imageInput">Imagen:</label>
            <div id="imageContainer"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        <button type="submit" class="btn btn-primary" id="addQuantityBtn">Agregar</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal fin -->

<!-- Nuevo Modal para Edición de Elementos -->
<div class="modal fade" id="editItemModal" tabindex="-1" role="dialog" aria-labelledby="editItemModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editItemModalLabel">Editar Elemento de Lista de Compras</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Formulario de Edición de Elemento -->
        <form id="editItemForm">
          <div class="form-group">
            <label for="editDescription">Descripción:</label>
            <textarea class="form-control" id="editDescription" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="editQuantity">Cantidad:</label>
            <input type="text" class="form-control" id="editQuantity">
          </div>
          <div class="form-group">
            <label for="editPrice">Precio:</label>
            <input type="text" class="form-control" id="editPrice">
          </div>
          <div class="form-group">
            <label for="editTotal">Total:</label>
            <input type="text" class="form-control" id="editTotal">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="deleteItemBtn">Borrar</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="saveChangesBtn">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal edicion fin -->

  
</body>
</html>
