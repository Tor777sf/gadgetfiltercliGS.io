<!--segundo nivel 2.5-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheet CSV</title>

  <!-- LIBRERIAS -->
  <!-- Bulma CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">

  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

  <!-- Popper.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>

  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>

  <!-- PapaParse JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

  <!-- PDFLib JS -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

  <!-- jsPDF JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <!-- FIN LIBRERIAS -->
  
  <!-- DISEÑO Y ESTRUCTURA WEB--> 
  <style>
    /* Coloca aquí el bloque de estilos CSS */
    .shopping-item {
      font-size: 16px;
      list-style-type: none;
      padding: 8px 0;
      border-bottom: 1px solid #ccc;
    }

    .item-quantity {
      display: inline-block;
      width: 10%;
    }

    .item-description {
      display: inline-block;
      width: 50%;
    }

    .item-total {
      display: inline-block;
      width: 30%;
      text-align: right;
    }
  </style>
  <!-- FIN DISEÑO Y ESTRUCTURA WEB-->
  
</head>
<body>
  
  <!-- DISEÑO Y ESTRUCTURA WEB-->
  
  <!-- Nueva sección para la lista de compra -->
  <div id="shoppingList">
    <h2>Lista de Compra</h2>
    <ul id="shoppingItems">
      <!-- Los ítems de la lista de compra se agregarán aquí dinámicamente -->
    </ul>
    <p>Total de Compra: <span id="totalPurchase">$0.00</span></p>
    <button id="whatsappButton">Compartir por WhatsApp</button>
    <button id="downloadPDFButton">Descargar PDF</button>
  </div>
  
  <table id="myDataTable" class="display">
    <!-- DataTable content will be dynamically generated here -->
  </table>

  <!-- FIN DISEÑO Y ESTRUCTURA WEB-->

  <script>
    // Función de inicialización para el DataTable
function initDataTable() {
  Papa.parse('https://docs.google.com/spreadsheets/d/1X0WN5st8Bl6G6_QPtC9gS6vY4PyFR5dAjXxWU7UiOYE/export?format=csv&gid=0', {
    download: true,
    header: true,
    dynamicTyping: true,
    complete: function (results) {
      var dataTable = $('#myDataTable').DataTable({
        data: results.data,
        columns: Object.keys(results.data[0]).map(function(key) {
          return { data: key, title: key };
        }),
        columnDefs: [
          {
            targets: 10,
            render: function (data, type, row) {
              return data && data !== "" ? '<a href="' + data + '" target="_blank"><img src="' + data + '" alt="Ver Foto" style="height: 100px; width: auto;" /></a>' : "";
            }
          }
        ]
      });
    }
  });
}

// Función de inicialización para la lista de compra
function initShoppingList() {
  $('#downloadPDFButton').on('click', function () {
    try {
      var doc = new jsPDF();
      doc.text(formatShoppingListForPDF(), 10, 10);
      doc.save('lista_de_compra.pdf');
    } catch (error) {
      alert('Error al crear/descargar el PDF: ' + error.message);
    }
  });

  $('#whatsappButton').on('click', function () {
    try {
      var message = formatShoppingListForWhatsApp();
      var whatsappURL = 'https://wa.me/?text=' + encodeURIComponent(message);
      window.open(whatsappURL, '_blank');
    } catch (error) {
      alert('Error al compartir en WhatsApp: ' + error.message);
    }
  });
}

// Función para formatear la lista de compra para WhatsApp
function formatShoppingListForWhatsApp() {
  let formattedList = '*📋 Lista de Compra:*\n\n';
  $('#shoppingItems li').each(function() {
    var quantity = $(this).find('.item-quantity').text();
    var description = $(this).find('.item-description').text();
    var total = $(this).find('.item-total').text();
    formattedList += `${quantity} x ${description}: ${total}\n`;
  });
  return formattedList;
}

// Función para formatear la lista de compra para el PDF
function formatShoppingListForPDF() {
  let formattedList = 'Lista de Compra:\n\n';
  $('#shoppingItems li').each(function() {
    var quantity = $(this).find('.item-quantity').text();
    var description = $(this).find('.item-description').text();
    var total = $(this).find('.item-total').text();
    formattedList += `${quantity} x ${description}: ${total}\n`;
  });
  return formattedList;
}
///////////////////////////////
// Función para seleccionar un elemento de la tabla
function selectTableElement() {
  $('#myDataTable').on('click', 'tr', function() {
    try {
      var rowData = $(this).find('td').map(function() {
        return $(this).text().trim();
      }).get();
      showModalAndLoadFields(rowData); // Llamar a la función para mostrar el modal y cargar los campos
    } catch (error) {
      alert('Error al seleccionar el elemento de la tabla: ' + error.message);
    }
  });
}


// Función para mostrar la imagen del campo ENLACES en el modal

function showImageInModal(data,rowData) {
  try {
    var imageLink = data.ENLACES; // Obtener el enlace de la imagen directamente de la columna "ENLACES"
    alert("Valor de imageLink: " + imageLink); // Agregar alerta para mostrar el valor de imageLink
    
    if (imageLink) {
      // Mostrar la imagen en el modal después de un pequeño retraso
      setTimeout(function() {
        $('#imageContainer').html('<img src="' + imageLink + '" alt="Imagen del producto">');
        $('#detailsModal').modal('show');
      }, 100); // Esperar 100 milisegundos antes de mostrar el modal
    } else {
      $('#imageContainer').html('Imagen no disponible');
      $('#detailsModal').modal('show');
    }
  } catch (error) {
    alert('Error al mostrar la imagen en el modal: ' + error.message);
  }
}




//--------------------&&&&&---------


// Función para mostrar el modal y cargar los campos
function showModalAndLoadFields(rowData) {
  try {
    var description = rowData[1];
    var quantity = rowData[1];
    var price = rowData[9];
    
    if (description.toLowerCase() === "xp") {
      $('#descriptionInput').val('');
      $('#quantityInput').val(1);
      $('#priceInput').val('$0.00');
    } else {
      $('#descriptionInput').val(description);
      $('#quantityInput').val(1);
      $('#priceInput').val(price);
    }
    
    showImageInModal(rowData); // Mostrar la imagen en el modal
    
    $('#detailsModal').modal('show');
  } catch (error) {
    throw new Error('Error al mostrar el modal y cargar los campos: ' + error.message);
  }
}

// Función principal para inicializar el proceso
function initializeProcess() {
  try {
    selectTableElement();
  } catch (error) {
    alert('Error al inicializar el proceso: ' + error.message);
  }
}




//////////////////////::::::::::::::::
// Inicialización al cargar el documento
$(document).ready(function () {
  initDataTable();
  initShoppingList();
  initializeProcess();// a dar clic enun item
});

  </script>

  <!-- DISEÑO Y ESTRUCTURA WEB-->
<!-- Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Detalles del Producto</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="detailsForm">
          <div class="form-group">
            <label for="descriptionInput">Descripción:</label>
            <input type="text" class="form-control" id="descriptionInput">
          </div>
          <div class="form-group">
            <label for="quantityInput">Cantidad:</label>
            <input type="number" class="form-control" id="quantityInput" value="1" required>
          </div>
          <div class="form-group">
            <label for="priceInput">Precio:</label>
            <input type="text" class="form-control" id="priceInput">
          </div>
          <div class="form-group">
            <label for="imageInput">Imagen:</label>
            <div id="imageContainer"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        <button type="submit" class="btn btn-primary" id="addDetailsBtn">Agregar</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal fin -->

  
<!-- FIN DISEÑO Y ESTRUCTURA WEB-->
  
</body>
</html>
